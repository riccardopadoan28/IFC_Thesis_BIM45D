<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#0f172a" />
  <title>3D Viewer</title>

  <!-- Simplified loader: always load from CDN to avoid missing local chunks -->
  <script type="module">
    import 'https://cdn.jsdelivr.net/npm/@xeokit/xeokit-webcomponents/dist/index.min.js';
    console.log('xeokit-webcomponents loaded from CDN');
  </script>

  <style>
    :root { --bg:#0b1220; --panel:#0f172a; --muted:#94a3b8; --text:#e2e8f0; --primary:#38bdf8; --accent:#a78bfa; }
    *{box-sizing:border-box} html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,"Segoe UI",Roboto,Inter,Arial,sans-serif}
    #app{height:100vh;display:grid;grid-template-rows:56px 1fr}
    .appbar{display:flex;align-items:center;gap:12px;padding:8px 12px;background:linear-gradient(180deg,rgba(15,23,42,.7),rgba(15,23,42,.95));border-bottom:1px solid rgba(148,163,184,.08);backdrop-filter:blur(6px);position:sticky;top:0;z-index:5}
    .brand{display:flex;align-items:center;gap:10px;font-weight:600;letter-spacing:.2px}
    .brand-badge{width:28px;height:28px;border-radius:8px;background:linear-gradient(135deg,var(--primary),var(--accent));box-shadow:0 0 0 1px rgba(56,189,248,.3),0 8px 24px rgba(56,189,248,.15)}
    .appbar .spacer{flex:1}
    .toolbar{display:flex;gap:8px;align-items:center}
    .btn{display:inline-flex;align-items:center;gap:8px;height:34px;padding:0 12px;border:1px solid rgba(148,163,184,.18);border-radius:8px;background:rgba(15,23,42,.6);color:var(--text);cursor:pointer;transition:all .18s ease}
    .btn:hover{border-color:rgba(148,163,184,.4);background:rgba(28,38,62,.8)} .btn.primary{border-color:rgba(56,189,248,.5);background:rgba(2,132,199,.2)} .btn svg{width:16px;height:16px;opacity:.9}
    .input{height:34px;min-width:280px;padding:0 12px;border-radius:8px;border:1px solid rgba(148,163,184,.18);background:rgba(2,6,23,.5);color:var(--text);outline:none} .input::placeholder{color:var(--muted)}
    .stage{position:relative;height:100%} xeo-viewer{position:absolute;inset:0}
    .loading{position:absolute;inset:0;display:grid;place-items:center;background:radial-gradient(1200px 800px at 50% 20%,rgba(2,6,23,.25),rgba(2,6,23,.85));z-index:4;transition:opacity .2s ease} .loading.hidden{opacity:0;pointer-events:none}
    .spinner{width:40px;height:40px;border:3px solid rgba(148,163,184,.25);border-top-color:var(--primary);border-radius:50%;animation:spin 1s linear infinite}@keyframes spin{to{transform:rotate(360deg)}}
    .dropzone{position:absolute;inset:0;display:none;place-items:center;z-index:6} .dropzone.active{display:grid}
    .dropzone .hint{padding:16px 22px;border-radius:12px;border:1px dashed rgba(148,163,184,.35);background:rgba(2,6,23,.6);color:var(--text);backdrop-filter:blur(4px)}
  </style>
</head>

<body>
  <div id="app">
    <!-- App Bar -->
    <div class="appbar">
      <div class="brand">
        <div class="brand-badge"></div>
        <div>IFC Viewer</div>
      </div>

      <div class="toolbar">
        <button id="openBtn" class="btn">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M4 19h16M5 19V8a2 2 0 0 1 2-2h4l2 2h4a2 2 0 0 1 2 2v9"/></svg>
          Open
        </button>
        <input id="urlInput" class="input" type="text" placeholder="/static/temp_file/model.xkt or .ifc" />
        <button id="loadBtn" class="btn primary">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M12 3v12m0 0l-4-4m4 4l4-4M4 21h16"/></svg>
          Load
        </button>
      </div>

      <div class="spacer"></div>

      <div class="toolbar">
        <button id="transparentBtn" class="btn" title="Toggle transparency">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M4 4h16v16H4z"/><path d="M4 12h16"/></svg>
          Transparency
        </button>
        <button id="fullscreenBtn" class="btn" title="Fullscreen">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M8 3H5a2 2 0 0 0-2 2v3M21 8V5a2 2 0 0 0-2-2h-3M3 16v3a2 2 0 0 0 2 2h3M16 21h3a2 2 0 0 0 2-2v-3"/></svg>
          Fullscreen
        </button>
      </div>
    </div>

    <!-- Stage -->
    <div class="stage" id="stage">
      <div id="dropzone" class="dropzone"><div class="hint">Drop .xkt / .ifc file here</div></div>
      <div id="loading" class="loading"><div class="spinner"></div></div>

      <xeo-viewer id="viewer-1" transparent="true">
        <xeo-tree-view-panel width="360px" bgColor="rgba(15,23,42,0.9)" position="right">
          <xeo-tree-view id="tree-view-1" hierarchy="containment" autoExpandDepth="3"></xeo-tree-view>
          <xeo-tree-view hierarchy="types" autoExpandDepth="1"></xeo-tree-view>
          <xeo-tree-view hierarchy="storeys" autoExpandDepth="2"></xeo-tree-view>
        </xeo-tree-view-panel>
        <xeo-fast-nav scale-canvas-resolution="true" scale-canvas-resolution-factor="0.6"></xeo-fast-nav>
        <xeo-model id="model-1" bounding-box="true"></xeo-model>
      </xeo-viewer>
    </div>
  </div>

  <input id="fileInput" type="file" accept=".xkt,.ifc,.laz,.glb,.gltf" hidden />

  <script>
    // Query/default src helpers
    function getSrcFromQuery() { const url = new URL(window.location.href); return url.searchParams.get('src'); }
    function resolveDefaultSrc() { return '/static/temp_file/model.xkt'; }
    function normalizeSrc(src) {
      if (!src) return '';
      const lower = src.toLowerCase();
      if (lower.endsWith('.ifc') && !lower.startsWith('ifc;')) return 'ifc;' + src;
      if (lower.endsWith('.laz') && !lower.startsWith('las;')) return 'las;' + src;
      return src;
    }

    const modelEl = document.getElementById('model-1');
    const viewerEl = document.getElementById('viewer-1');
    const loading = document.getElementById('loading');

    function setModelSrc(src) {
      const norm = normalizeSrc(src);
      if (!norm) return;
      loading.classList.remove('hidden');
      modelEl.setAttribute('src', norm);
      currentFileName(norm);
    }

    function currentFileName(src) {
      try {
        const clean = src.startsWith('ifc;') || src.startsWith('las;') ? src.split(';')[1] : src;
        const name = clean.split('?')[0].split('/').pop();
        document.title = `3D Viewer â€¢ ${name}`;
      } catch (_) {}
    }

    document.addEventListener('DOMContentLoaded', () => {
      let src = getSrcFromQuery() || resolveDefaultSrc();
      setModelSrc(src);

      // Loading overlay
      modelEl.addEventListener('model-loaded', () => loading.classList.add('hidden'));

      // Open via file dialog
      const openBtn = document.getElementById('openBtn');
      const fileInput = document.getElementById('fileInput');
      openBtn.addEventListener('click', () => fileInput.click());
      fileInput.addEventListener('change', (e) => {
        const f = e.target.files?.[0];
        if (!f) return;
        const url = URL.createObjectURL(f);
        const src = f.name.toLowerCase().endsWith('.ifc') ? 'ifc;' + url : url;
        setModelSrc(src);
      });

      // Load from URL field
      const urlInput = document.getElementById('urlInput');
      const loadBtn = document.getElementById('loadBtn');
      loadBtn.addEventListener('click', () => setModelSrc(urlInput.value.trim()));
      urlInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') setModelSrc(urlInput.value.trim()); });

      // Toolbar actions
      const transparentBtn = document.getElementById('transparentBtn');
      transparentBtn.addEventListener('click', () => {
        if (viewerEl.hasAttribute('transparent')) viewerEl.removeAttribute('transparent');
        else viewerEl.setAttribute('transparent', 'true');
      });

      const fullscreenBtn = document.getElementById('fullscreenBtn');
      const stage = document.getElementById('stage');
      fullscreenBtn.addEventListener('click', async () => {
        try {
          if (!document.fullscreenElement) await stage.requestFullscreen();
          else await document.exitFullscreen();
        } catch (e) { console.warn('Fullscreen not available', e); }
      });

      // Drag & drop support
      const dropzone = document.getElementById('dropzone');
      ['dragenter','dragover'].forEach(evt => stage.addEventListener(evt, (e)=>{ e.preventDefault(); dropzone.classList.add('active'); }));
      ;['dragleave','drop'].forEach(evt => stage.addEventListener(evt, (e)=>{ e.preventDefault(); dropzone.classList.remove('active'); }));
      stage.addEventListener('drop', (e) => {
        const f = e.dataTransfer?.files?.[0];
        if (f) {
          const url = URL.createObjectURL(f);
          const src = f.name.toLowerCase().endsWith('.ifc') ? 'ifc;' + url : url;
          setModelSrc(src);
          return;
        }
        const uri = e.dataTransfer?.getData('text/uri-list') || e.dataTransfer?.getData('text/plain');
        if (uri) setModelSrc(uri.trim());
      });
    });
  </script>

  <script type="module">
    import { XeoViewerService } from 'https://cdn.jsdelivr.net/npm/@xeokit/xeokit-webcomponents/dist/index.min.js';
    const viewer = XeoViewerService.getInstance().getViewer('viewer-1');
    const viewerComponent=document.getElementById('viewer-1'); viewerComponent.addEventListener('model-entity-clicked', e=>console.log('on model-entity-clicked:',{detail:e.detail}));
    const xktModel=document.getElementById('model-1'); xktModel.addEventListener('model-loaded', e=>console.log('on model-loaded:',{detail:e.detail}));
    const containmentTreeView=document.getElementById('tree-view-1'); containmentTreeView.addEventListener('tree-view-node-title-clicked', e=>{ const id=e?.detail?.treeViewNode?.objectId; let entity; try{entity=viewer.scene.objects[id]}catch{} const meta=entity?viewer.metaScene.metaObjects[entity.id]:undefined; console.log('on tree-view-node-title-clicked:',{detail:e.detail, entity, meta})});
    viewer.scene.input.on('mouseclicked', coords=>{ const hit=viewer.scene.pick({canvasPos:coords}); if(hit&&hit.entity&&hit.entity.isObject){ const entity=hit.entity; const meta=viewer.metaScene.metaObjects[entity.id]; if(meta){ console.log('Custom Clicked entity:',{ id:entity.id, name:meta.name, type:meta.type, volume:entity.volume, aabb:entity.aabb }); } } });
  </script>
</body>

</html>