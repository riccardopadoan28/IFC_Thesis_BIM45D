<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<style>
html,body,#root{height:100%;margin:0;}
#wrap{position:relative;width:100%;height:100%;background:#eef6ff;}
#myCanvas{width:100%;height:100%;position:absolute;background:lightblue;background-image:linear-gradient(lightblue,white);} 
#hint{position:absolute;top:10px;left:10px;background:rgba(0,0,0,.6);color:#fff;padding:6px 8px;border-radius:4px;font:12px sans-serif}
</style>
</head>
<body>
<div id="root">
  <div id="wrap">
    <canvas id="myCanvas"></canvas>
    <div id="hint" style="display:none">Inserisci un URL XKT valido per caricare il modello</div>
  </div>
</div>
<script type="module">
const XKT_URL = XKT_URL_JSON;
const META_URL = META_URL_JSON;
const XKT_B64 = XKT_B64_JSON; // supporto embed base64

import {Viewer, XKTLoaderPlugin} from "https://cdn.jsdelivr.net/npm/@xeokit/xeokit-sdk@1/dist/xeokit-sdk.es.min.js";

const viewer = new Viewer({
  canvasId: "myCanvas",
  transparent: true,
  dtxEnabled: true
});

viewer.camera.eye = [-3.933, 2.855, 27.018];
viewer.camera.look = [4.400, 3.724, 8.899];
viewer.camera.up = [-0.018, 0.999, 0.039];

function b64ToBlobUrl(b64){
  try{
    const bin = atob(b64);
    const len = bin.length;
    const bytes = new Uint8Array(len);
    for(let i=0;i<len;i++){ bytes[i]=bin.charCodeAt(i); }
    const blob = new Blob([bytes], {type:'application/octet-stream'});
    return URL.createObjectURL(blob);
  } catch(e){ return null; }
}

let resolvedURL = (XKT_URL && XKT_URL.trim()) ? XKT_URL : '';
if (!resolvedURL && XKT_B64 && XKT_B64.length>0){
  const blobUrl = b64ToBlobUrl(XKT_B64);
  if (blobUrl) resolvedURL = blobUrl;
}

if (resolvedURL) {
  const xktLoader = new XKTLoaderPlugin(viewer);
  const params = {
    id: "myModel",
    src: resolvedURL,
    saoEnabled: true,
    edges: true,
    dtxEnabled: true
  };
  if (!META_URL && /^https?:\/\//i.test(resolvedURL) && /\.xkt$/i.test(resolvedURL)) {
    params.metaModelSrc = resolvedURL.replace(/\.xkt$/i, '.json');
  } else if (META_URL) {
    params.metaModelSrc = META_URL;
  }
  const sceneModel = xktLoader.load(params);
  try {
    sceneModel.on && sceneModel.on("loaded", () => {
      try { viewer.cameraFlight.flyTo(sceneModel); } catch(e) {}
    });
  } catch(e) {}
} else {
  document.getElementById("hint").style.display = "block";
}
</script>
</body>
</html>
